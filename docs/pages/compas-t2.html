<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Causal Fairness Analysis - Software - Task 2: Fair Predictions on COMPAS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Causal Fairness Analysis - Software</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">Home</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../pages/census-t1.html">Census Task 1</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/college-admissions-t1.html">College Admissions Task 1</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/compas-t1.html">COMPAS Task 1</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../pages/compas-t2.html" aria-current="page">COMPAS Task 2</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/shai-challenge.html">COMPAS TV/EO</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/compas-t2.html">Fairadapt</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/ci-tests.html">CI Tests</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#fair-predictions-on-compas" id="toc-fair-predictions-on-compas" class="nav-link active" data-scroll-target="#fair-predictions-on-compas">Fair Predictions on COMPAS</a>
  <ul class="collapse">
  <li><a href="#are-the-methods-successful-at-eliminating-discrimination" id="toc-are-the-methods-successful-at-eliminating-discrimination" class="nav-link" data-scroll-target="#are-the-methods-successful-at-eliminating-discrimination">Are the methods successful at eliminating discrimination?</a></li>
  </ul></li>
  <li><a href="#how-to-fix-the-issue" id="toc-how-to-fix-the-issue" class="nav-link" data-scroll-target="#how-to-fix-the-issue">How to fix the issue?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Task 2: Fair Predictions on COMPAS</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>In this vignette, we focus on Task 2 (Fair Prediction), and specifically focus on the limitation of the currently found methods in the literature to provide causally meaningful fair predictions.</p>
<section id="fair-predictions-on-compas" class="level2">
<h2 class="anchored" data-anchor-id="fair-predictions-on-compas">Fair Predictions on COMPAS</h2>
<p>A team of data scientists from ProPublica have shown that the COMPAS dataset from Broward County contains a strong racial bias against minorities. They are now interested in producing fair predictions <span class="math inline">\(\widehat{Y}\)</span> on the dataset, to replace the biased predictions. They first load the COMPAS data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">data</span>(<span class="st">"compas"</span>, <span class="at">package =</span> <span class="st">"faircause"</span>))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(dat), <span class="at">caption =</span> <span class="st">"COMPAS dataset."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>COMPAS dataset.</caption>
<colgroup>
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 9%">
<col style="width: 12%">
<col style="width: 13%">
<col style="width: 14%">
<col style="width: 12%">
<col style="width: 14%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">sex</th>
<th style="text-align: right;">age</th>
<th style="text-align: left;">race</th>
<th style="text-align: right;">juv_fel_count</th>
<th style="text-align: right;">juv_misd_count</th>
<th style="text-align: right;">juv_other_count</th>
<th style="text-align: right;">priors_count</th>
<th style="text-align: left;">c_charge_degree</th>
<th style="text-align: right;">two_year_recid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Male</td>
<td style="text-align: right;">69</td>
<td style="text-align: left;">Non-White</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">F</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Male</td>
<td style="text-align: right;">34</td>
<td style="text-align: left;">Non-White</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">F</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Male</td>
<td style="text-align: right;">24</td>
<td style="text-align: left;">Non-White</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">F</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Male</td>
<td style="text-align: right;">23</td>
<td style="text-align: left;">Non-White</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">F</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Male</td>
<td style="text-align: right;">43</td>
<td style="text-align: left;">Non-White</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">F</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Male</td>
<td style="text-align: right;">44</td>
<td style="text-align: left;">Non-White</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">M</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the metadata</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mdat <span class="ot">&lt;-</span> <span class="fu">get_metadata</span>(<span class="st">"compas"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To produce fair predictions, they first experiment with four different classifiers.</p>
<section id="i-random-forest-without-fairness-constraints" class="level4">
<h4 class="anchored" data-anchor-id="i-random-forest-without-fairness-constraints"><strong>(i)</strong> Random Forest without fairness constraints</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 1: Random Forest</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>org_dat <span class="ot">&lt;-</span> dat</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>org_dat<span class="sc">$</span>two_year_recid <span class="ot">&lt;-</span> <span class="fu">ranger</span>(two_year_recid <span class="sc">~</span> ., dat,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">classification =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>predictions</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 1: decompose Total Variation</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>org_tvd <span class="ot">&lt;-</span> <span class="fu">fairness_cookbook</span>(org_dat, mdat[[<span class="st">"X"</span>]], mdat[[<span class="st">"W"</span>]], mdat[[<span class="st">"Z"</span>]],</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                             mdat[[<span class="st">"Y"</span>]], mdat[[<span class="st">"x0"</span>]], mdat[[<span class="st">"x1"</span>]])</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>org_plt <span class="ot">&lt;-</span> <span class="fu">autoplot</span>(org_tvd, <span class="at">decompose =</span> <span class="st">"xspec"</span>, <span class="at">dataaset =</span> dataset) <span class="sc">+</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">""</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ii-logistic-regression-trained-with-reweighing-kamiran2012data" class="level4">
<h4 class="anchored" data-anchor-id="ii-logistic-regression-trained-with-reweighing-kamiran2012data"><strong>(ii)</strong> Logistic regression trained with <em>reweighing</em> <span class="citation" data-cites="kamiran2012data">(<a href="#ref-kamiran2012data" role="doc-biblioref">Kamiran and Calders 2012</a>)</span></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">exec</span>(<span class="bu">open</span>(os.path.join(r.root, <span class="st">"py"</span>, <span class="st">"reweighing_compas.py"</span>)).read())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING:root:No module named 'tempeh': LawSchoolGPADataset will be unavailable. To install, run:
pip install 'aif360[LawSchoolGPA]'
WARNING:root:No module named 'tensorflow': AdversarialDebiasing will be unavailable. To install, run:
pip install 'aif360[AdversarialDebiasing]'
WARNING:root:No module named 'tensorflow': AdversarialDebiasing will be unavailable. To install, run:
pip install 'aif360[AdversarialDebiasing]'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>Yhat_rew <span class="op">=</span> reweigh_and_predict(r.dat, r.dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 2: Reweighing by Kamiran &amp; Calders</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>reweigh_dat <span class="ot">&lt;-</span> dat</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>reweigh_dat<span class="sc">$</span>two_year_recid <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(py<span class="sc">$</span>Yhat_rew)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>reweigh_tvd <span class="ot">&lt;-</span> <span class="fu">fairness_cookbook</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  reweigh_dat, mdat[[<span class="st">"X"</span>]], mdat[[<span class="st">"W"</span>]], mdat[[<span class="st">"Z"</span>]], mdat[[<span class="st">"Y"</span>]], mdat[[<span class="st">"x0"</span>]],</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  mdat[[<span class="st">"x1"</span>]])</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>rew_plt <span class="ot">&lt;-</span> <span class="fu">autoplot</span>(reweigh_tvd, <span class="at">decompose =</span> <span class="st">"xspec"</span>, <span class="at">dataset =</span> dataset) <span class="sc">+</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">""</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="iii-fair-reductions-approach-of-agarwal2018reductions" class="level4">
<h4 class="anchored" data-anchor-id="iii-fair-reductions-approach-of-agarwal2018reductions"><strong>(iii)</strong> Fair Reductions approach of <span class="citation" data-cites="agarwal2018reductions">(<a href="#ref-agarwal2018reductions" role="doc-biblioref">Agarwal et al. 2018</a>)</span></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">exec</span>(<span class="bu">open</span>(os.path.join(r.root, <span class="st">"py"</span>, <span class="st">"reductions_compas.py"</span>)).read())</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Yhat_red <span class="op">=</span> reduce_and_predict(r.dat, r.dat, <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 3: Reductions (Agarwal et. al.)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source_python</span>(<span class="fu">file.path</span>(root, <span class="st">"py"</span>, <span class="fu">paste0</span>(<span class="st">"reductions_"</span>, dataset, <span class="st">".py"</span>)))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>red_dat <span class="ot">&lt;-</span> dat</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>red_dat<span class="sc">$</span>two_year_recid <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(py<span class="sc">$</span>Yhat_red)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>red_tvd <span class="ot">&lt;-</span> <span class="fu">fairness_cookbook</span>(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  red_dat, mdat[[<span class="st">"X"</span>]], mdat[[<span class="st">"W"</span>]], mdat[[<span class="st">"Z"</span>]], mdat[[<span class="st">"Y"</span>]], mdat[[<span class="st">"x0"</span>]],</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  mdat[[<span class="st">"x1"</span>]]</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>red_plt <span class="ot">&lt;-</span> <span class="fu">autoplot</span>(red_tvd, <span class="at">decompose =</span> <span class="st">"xspec"</span>, <span class="at">dataset =</span> dataset) <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">""</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="iv-random-forest-with-reject-option-post-processing-kamiran2012decision" class="level4">
<h4 class="anchored" data-anchor-id="iv-random-forest-with-reject-option-post-processing-kamiran2012decision"><strong>(iv)</strong> Random Forest with <em>reject-option</em> post-processing <span class="citation" data-cites="kamiran2012decision">(<a href="#ref-kamiran2012decision" role="doc-biblioref">Kamiran, Karim, and Zhang 2012</a>)</span></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 4: reject-option classification</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>rjo_prb <span class="ot">&lt;-</span> <span class="fu">ranger</span>(two_year_recid <span class="sc">~</span> ., dat, <span class="at">probability =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>predictions[, <span class="dv">2</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>rjo_dat <span class="ot">&lt;-</span> dat</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>rjo_dat<span class="sc">$</span>two_year_recid <span class="ot">&lt;-</span> <span class="fu">RejectOption</span>(rjo_prb, rjo_dat<span class="sc">$</span>race)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>rjo_tvd <span class="ot">&lt;-</span> <span class="fu">fairness_cookbook</span>(rjo_dat, mdat[[<span class="st">"X"</span>]], mdat[[<span class="st">"W"</span>]], mdat[[<span class="st">"Z"</span>]],</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                             mdat[[<span class="st">"Y"</span>]], mdat[[<span class="st">"x0"</span>]], mdat[[<span class="st">"x1"</span>]])</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>rjo_plt <span class="ot">&lt;-</span> <span class="fu">autoplot</span>(rjo_tvd, <span class="at">decompose =</span> <span class="st">"xspec"</span>, <span class="at">dataset =</span> dataset) <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">""</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="are-the-methods-successful-at-eliminating-discrimination" class="level3">
<h3 class="anchored" data-anchor-id="are-the-methods-successful-at-eliminating-discrimination">Are the methods successful at eliminating discrimination?</h3>
<p>The fair prediction algorithms used above are intended to set the TV measure to <span class="math inline">\(0\)</span>. After constructing these predictors, the ProPublica team made use of the Fairness Cookbook, to inspect the causal implications of the methods. Following the steps of the Fairness Cookbook, the team computes the TV measure, together with the appropriate measures of direct, indirect, and spurious discrimination. We can now visualize these decompositions in <a href="#fig-compas-fairpred">Figure&nbsp;1</a>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-compas-fairpred" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="compas-t2_files/figure-html/fig-compas-fairpred-1.png" class="img-fluid figure-img" width="1536"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Fair Predictions on the COMPAS dataset.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The ProPublica team notes that all methods substantially reduce the <span class="math inline">\(\text{TV}_{x_0,x_1}(\widehat{y})\)</span>, however, the measures of direct, indirect, and, spurious effects are not necessarily reduced to <span class="math inline">\(0\)</span>, consistent with the Fair Prediction Theorem.</p>
</section>
</section>
<section id="how-to-fix-the-issue" class="level2">
<h2 class="anchored" data-anchor-id="how-to-fix-the-issue">How to fix the issue?</h2>
<p>To produce causally meaningful fair predictions, we suggest using the <code>fairadapt</code> package <span class="citation" data-cites="plevcko2020fair plevcko2021fairadapt">(<a href="#ref-plevcko2020fair" role="doc-biblioref">Plečko and Meinshausen 2020</a>; <a href="#ref-plevcko2021fairadapt" role="doc-biblioref">Plečko, Bennett, and Meinshausen 2021</a>)</span>. In particular, the package offers a way of removing discrimination which is based on the causal diagram. In this application, we are interested in constructing fair predictions that remove both the direct and the indirect effect. Firstly, we obtain the adjacency matrix representing the causal diagram associated with the COMPAS dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2022</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># load the causal diagram</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>mats <span class="ot">&lt;-</span> <span class="fu">get_mat</span>(dataset)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>adj.mat <span class="ot">&lt;-</span> mats[[1L]]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>cfd.mat <span class="ot">&lt;-</span> mats[[2L]]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>causal_graph <span class="ot">&lt;-</span> fairadapt<span class="sc">::</span><span class="fu">graphModel</span>(adj.mat, cfd.mat)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(causal_graph, <span class="at">size =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="compas-t2_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>After loading the causal diagram, we perform fair data adaptation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fdp <span class="ot">&lt;-</span> fairadapt<span class="sc">::</span><span class="fu">fairadapt</span>(two_year_recid <span class="sc">~</span> ., <span class="at">prot.attr =</span> <span class="st">"race"</span>,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">train.data =</span> dat, <span class="at">adj.mat =</span> adj.mat)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain the adapted data</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>ad_dat <span class="ot">&lt;-</span> fairadapt<span class="sc">:::</span><span class="fu">adaptedData</span>(fdp)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>ad_dat<span class="sc">$</span>race <span class="ot">&lt;-</span> dat<span class="sc">$</span>race</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain predictions based on the adapted data</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>adapt_oob <span class="ot">&lt;-</span> <span class="fu">ranger</span>(two_year_recid <span class="sc">~</span> ., ad_dat,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">classification =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>predictions</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>ad_dat<span class="sc">$</span>two_year_recid <span class="ot">&lt;-</span> adapt_oob</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># decompose the TV for the predictions</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>dat.fairadapt <span class="ot">&lt;-</span> dat</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>dat.fairadapt<span class="sc">$</span>two_year_recid <span class="ot">&lt;-</span> adapt_oob</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>fairadapt_tvd <span class="ot">&lt;-</span> <span class="fu">fairness_cookbook</span>(</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  ad_dat, mdat[[<span class="st">"X"</span>]], mdat[[<span class="st">"W"</span>]], mdat[[<span class="st">"Z"</span>]],</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  mdat[[<span class="st">"Y"</span>]], mdat[[<span class="st">"x0"</span>]], mdat[[<span class="st">"x1"</span>]]</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the decomposition</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>fairadapt_plt <span class="ot">&lt;-</span> <span class="fu">autoplot</span>(fairadapt_tvd, <span class="at">decompose =</span> <span class="st">"xspec"</span>, <span class="at">dataset =</span> dataset) <span class="sc">+</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">""</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">""</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>fairadapt_plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-compas-fairadapt" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="compas-t2_files/figure-html/fig-compas-fairadapt-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: Fair Data Adaptation on the COMPAS dataset.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-compas-fairadapt">Figure&nbsp;2</a> shows how the <code>fairadapt</code> package can be used to provide causally meaningful predictions that remove both direct and indirect effects.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-agarwal2018reductions" class="csl-entry" role="doc-biblioentry">
Agarwal, Alekh, Alina Beygelzimer, Miroslav Dudík, John Langford, and Hanna Wallach. 2018. <span>“A Reductions Approach to Fair Classification.”</span> In <em>International Conference on Machine Learning</em>, 60–69. PMLR.
</div>
<div id="ref-kamiran2012data" class="csl-entry" role="doc-biblioentry">
Kamiran, Faisal, and Toon Calders. 2012. <span>“Data Preprocessing Techniques for Classification Without Discrimination.”</span> <em>Knowledge and Information Systems</em> 33 (1): 1–33.
</div>
<div id="ref-kamiran2012decision" class="csl-entry" role="doc-biblioentry">
Kamiran, Faisal, Asim Karim, and Xiangliang Zhang. 2012. <span>“Decision Theory for Discrimination-Aware Classification.”</span> In <em>2012 IEEE 12th International Conference on Data Mining</em>, 924–29. IEEE.
</div>
<div id="ref-plevcko2021fairadapt" class="csl-entry" role="doc-biblioentry">
Plečko, Drago, Nicolas Bennett, and Nicolai Meinshausen. 2021. <span>“Fairadapt: Causal Reasoning for Fair Data Pre-Processing.”</span> <em>arXiv Preprint arXiv:2110.10200</em>.
</div>
<div id="ref-plevcko2020fair" class="csl-entry" role="doc-biblioentry">
Plečko, Drago, and Nicolai Meinshausen. 2020. <span>“Fair Data Adaptation with Quantile Preservation.”</span> <em>Journal of Machine Learning Research</em> 21: 242.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>