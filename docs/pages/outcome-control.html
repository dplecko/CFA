<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Causal Fairness Analysis - Software - Outcome Control – Cancer Surgery Example</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Causal Fairness Analysis - Software</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../pages/census-t1.html" rel="" target="">
 <span class="menu-text">Census Task 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/college-admissions-t1.html" rel="" target="">
 <span class="menu-text">College Admissions Task 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/compas-t1.html" rel="" target="">
 <span class="menu-text">COMPAS Task 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/compas-t1-extended.html" rel="" target="">
 <span class="menu-text">COMPAS Task 1 (Extended)</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/compas-t2.html" rel="" target="">
 <span class="menu-text">COMPAS Task 2</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/shai-challenge.html" rel="" target="">
 <span class="menu-text">COMPAS TV/EO</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/compas-t2.html" rel="" target="">
 <span class="menu-text">Fairadapt</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../pages/ci-tests.html" rel="" target="">
 <span class="menu-text">CI Tests</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../pages/outcome-control.html" rel="" target="" aria-current="page">
 <span class="menu-text">Outcome Control</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#oracles-perspective" id="toc-oracles-perspective" class="nav-link active" data-scroll-target="#oracles-perspective">Oracle’s Perspective</a></li>
  <li><a href="#decision-makers-perspective" id="toc-decision-makers-perspective" class="nav-link" data-scroll-target="#decision-makers-perspective">Decision-maker’s Perspective</a></li>
  <li><a href="#computing-the-disparity-in-treatment-allocation" id="toc-computing-the-disparity-in-treatment-allocation" class="nav-link" data-scroll-target="#computing-the-disparity-in-treatment-allocation">Computing the Disparity in Treatment Allocation</a></li>
  <li><a href="#decomposing-the-disparity" id="toc-decomposing-the-disparity" class="nav-link" data-scroll-target="#decomposing-the-disparity">Decomposing the Disparity</a></li>
  <li><a href="#constructing-the-causally-fair-dcf-policy" id="toc-constructing-the-causally-fair-dcf-policy" class="nav-link" data-scroll-target="#constructing-the-causally-fair-dcf-policy">Constructing the causally fair <span class="math inline">\(D^{CF}\)</span> policy</a></li>
  <li><a href="#constructing-the-causally-fair-dut-policy" id="toc-constructing-the-causally-fair-dut-policy" class="nav-link" data-scroll-target="#constructing-the-causally-fair-dut-policy">Constructing the causally fair <span class="math inline">\(D^{UT}\)</span> policy</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Outcome Control – Cancer Surgery Example</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="oracles-perspective" class="level2">
<h2 class="anchored" data-anchor-id="oracles-perspective">Oracle’s Perspective</h2>
<p>Consider the structural causal model (SCM) introduced in Ex. 5.10 of the paper <span class="citation" data-cites="plecko2022causal">(<a href="#ref-plecko2022causal" role="doc-biblioref">Plecko and Bareinboim 2022</a>)</span>: <span class="math display">\[\begin{align}
X  &amp;\gets U_X \label{eq:cancer-scm-1} \\
                    W &amp;\gets \begin{cases} \sqrt{U_W} \text{ if } X = x_0, \\
                    1 - \sqrt{1 - U_W} \text{ if } X = x_1
                    \end{cases}  \\
                D &amp; \gets f_D(X, W) \\
                Y  &amp;\gets \mathbb{1}(U_Y + \frac{1}{3} WD - \frac{1}{5} W &gt; 0.5). \\
                    U_X &amp;\in \{0,1\}, P(U_X = 1) = 0.5, \\
                    %U_Z&amp;,
                        U_W&amp;, U_Y \sim \text{Unif}[0, 1], \label{eq:cancer-scm-n}
\end{align}\]</span> We begin by generating <span class="math inline">\(n = 5000\)</span> samples from the SCM:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># generate data from the SCM</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>uw <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(x, <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>uw), <span class="fu">sqrt</span>(uw)) </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>uy <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># f_Y coefficients</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>alph <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">5</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># assuming a policy D s.t. P(d | w) = w.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> w)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(uy <span class="sc">+</span> beta <span class="sc">*</span> w <span class="sc">*</span>d <span class="sc">-</span> alph <span class="sc">*</span> w <span class="sc">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Doomed"</span>, <span class="st">"Helped"</span>, <span class="st">"Safe"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> beta <span class="sc">*</span> w</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># determine canonical type</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>canon <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(uy <span class="sc">&gt;</span> <span class="fl">0.5</span> <span class="sc">+</span> w <span class="sc">*</span> alph, <span class="st">"Safe"</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ifelse</span>(uy <span class="sc">&gt;</span> <span class="fl">0.5</span> <span class="sc">+</span> w <span class="sc">*</span> alph <span class="sc">-</span> w <span class="sc">*</span> beta, <span class="st">"Helped"</span>, <span class="st">"Doomed"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The latent variable <span class="math inline">\(U_Y\)</span> determines which canonical type the individual belongs to. After generating the data, we visualize it from the oracle’s perspective, assuming access to <span class="math inline">\(U_Y\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="outcome-control_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the oracle’s perspective, treating individuals in the green area is optimal. However, we next look at the perspective of the decision-maker:</p>
</section>
<section id="decision-makers-perspective" class="level2">
<h2 class="anchored" data-anchor-id="decision-makers-perspective">Decision-maker’s Perspective</h2>
<p>We next plot the decision-maker’s perspective, which is based on estimating the benefit <span class="math inline">\(E[Y_{d_1} - Y_{d_0} \mid x, z, w]\)</span>. We first estimate the benefit from the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x, w, d, y)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># fit a logistic regression model</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>logreg <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x <span class="sc">+</span> w <span class="sc">*</span> d, <span class="at">data =</span> df, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># compute the potential outcomes</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>df_d0 <span class="ot">&lt;-</span> df_d1 <span class="ot">&lt;-</span> df</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>df_d0<span class="sc">$</span>d <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>df_d1<span class="sc">$</span>d <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>py_d0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(logreg, df_d0, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>py_d1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(logreg, df_d1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># compute the benefit</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>delta_hat <span class="ot">&lt;-</span> delta_hat <span class="ot">&lt;-</span> py_d1 <span class="sc">-</span> py_d0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After estimating <span class="math inline">\(\Delta\)</span>, we visualize the data based on the obtained estimates:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="outcome-control_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Therefore, when looking at the benefit, it is clearly higher for the <span class="math inline">\(X = x_0\)</span> group. This explains why the decision-maker may naturally decide to treat more individuals in the <span class="math inline">\(X = x_0\)</span> group.</p>
</section>
<section id="computing-the-disparity-in-treatment-allocation" class="level2">
<h2 class="anchored" data-anchor-id="computing-the-disparity-in-treatment-allocation">Computing the Disparity in Treatment Allocation</h2>
<p>We look at the policy <span class="math inline">\(D^*\)</span> obtained from Algorithm 5.3: <span class="math display">\[\begin{align}
  D^* = \mathbb{1}(\Delta &gt; \frac{1}{6}).
\end{align}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construct the decision policy </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>d_star <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(delta_hat <span class="sc">&gt;</span> <span class="fu">quantile</span>(delta_hat, <span class="fl">0.5</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># look at resource allocation in each group</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tapply</span>(d_star, x, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        0         1 
0.7513683 0.2366912 </code></pre>
</div>
</div>
<p>Therefore, we obtained that <span class="math display">\[\begin{align}
  P(d^* \mid x_1) - P(d^* \mid x_0) \approx -51.5\%.
\end{align}\]</span> The true population value (as shown in the paper) is -50%.</p>
</section>
<section id="decomposing-the-disparity" class="level2">
<h2 class="anchored" data-anchor-id="decomposing-the-disparity">Decomposing the Disparity</h2>
<p>We next look at decomposing the disparity using Algorithm 5.4. We first use the <code>faircause</code> package to decompose the disparity in resource allocation:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># implement the new policy</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>d <span class="ot">&lt;-</span> d_star</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the fairness cookbook</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>fc_d <span class="ot">&lt;-</span> <span class="fu">fairness_cookbook</span>(df, <span class="at">X =</span> <span class="st">"x"</span>, <span class="at">Z =</span> <span class="cn">NULL</span>, <span class="at">W =</span> <span class="st">"w"</span>, <span class="at">Y =</span> <span class="st">"d"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">x0 =</span> <span class="dv">0</span>, <span class="at">x1 =</span> <span class="dv">1</span>, <span class="at">nboot1 =</span> <span class="dv">5</span>, <span class="at">model =</span> <span class="st">"linear"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(fc_d, <span class="at">signed =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="fu">TeX</span>(<span class="st">"$P(d^* | x_1) - P(d^* | x_0)$ decomposition"</span>)) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"TV"</span>, <span class="st">"DE"</span>, <span class="st">"IE"</span>, <span class="st">"SE"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="outcome-control_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Therefore, as explained in the paper, the disparity is driven by the indirect effect. We can also decompose the disparity in the estimated benefit <span class="math inline">\(E[\Delta \mid x_1] - E[\Delta \mid x_0]\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the fairness cookbook</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>fc_delta <span class="ot">&lt;-</span> <span class="fu">fairness_cookbook</span>(df, <span class="at">X =</span> <span class="st">"x"</span>, <span class="at">Z =</span> <span class="cn">NULL</span>, <span class="at">W =</span> <span class="st">"w"</span>, <span class="at">Y =</span> <span class="st">"delta_hat"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">x0 =</span> <span class="dv">0</span>, <span class="at">x1 =</span> <span class="dv">1</span>, <span class="at">nboot1 =</span> <span class="dv">5</span>, <span class="at">model =</span> <span class="st">"linear"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(fc_delta, <span class="at">signed =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">TeX</span>(<span class="st">"$E[</span><span class="sc">\\</span><span class="st">Delta | x_1] - E[</span><span class="sc">\\</span><span class="st">Delta | x_0]$ decomposition"</span>)) <span class="sc">+</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"TV"</span>, <span class="st">"DE"</span>, <span class="st">"IE"</span>, <span class="st">"SE"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="outcome-control_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="constructing-the-causally-fair-dcf-policy" class="level2">
<h2 class="anchored" data-anchor-id="constructing-the-causally-fair-dcf-policy">Constructing the causally fair <span class="math inline">\(D^{CF}\)</span> policy</h2>
<p>The clinicians first want to construct the causally fair policy. For doing so, they first construct the counterfactual values of the illness severity. In particular, they assume that the relative order of the values remains the same under the counterfactual change of the protected attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get order statistics for the X = x_1 group</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ord_x1 <span class="ot">&lt;-</span> <span class="fu">order</span>(w[x <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># compute the sample quantile</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>quant_x1 <span class="ot">&lt;-</span> ord_x1 <span class="sc">/</span> <span class="fu">length</span>(ord_x1)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize the counterfactual values</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>w_cf <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># for X = x_0, values remain the same by consistency axiom</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>w_cf[x <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> w[x <span class="sc">==</span> <span class="dv">0</span>]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># for X = x_1, match to the corresponding quantile in the X = x_0 distribution</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>w_cf[x <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">vapply</span>(quant_x1, <span class="cf">function</span>(q) <span class="fu">quantile</span>(w[x <span class="sc">==</span> <span class="dv">0</span>], q), <span class="fu">numeric</span>(1L))</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># compute the counterfactual benefit</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>delta_cf <span class="ot">&lt;-</span> w_cf <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">mean</span>(d_star)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>fcf <span class="ot">&lt;-</span> <span class="fu">ecdf</span>(delta_cf)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>fcf.inv <span class="ot">&lt;-</span> <span class="fu">inverse</span>(fcf, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>d_cf <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(delta_cf <span class="sc">&gt;</span> <span class="fu">fcf.inv</span>(<span class="dv">1</span> <span class="sc">-</span> b))</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="fu">tapply</span>(d_cf, x, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0   1 
0.5 0.5 </code></pre>
</div>
</div>
<p>Therefore, we see that <span class="math display">\[\begin{align}
  P(d^{CF} \mid x_1) - P(d^{CF} \mid x_0) \approx 0\%.
\end{align}\]</span></p>
<p>The true population value of the disparity for <span class="math inline">\(D^{CF}\)</span>, discussed in the paper, also equals <span class="math inline">\(0\%\)</span>.</p>
</section>
<section id="constructing-the-causally-fair-dut-policy" class="level2">
<h2 class="anchored" data-anchor-id="constructing-the-causally-fair-dut-policy">Constructing the causally fair <span class="math inline">\(D^{UT}\)</span> policy</h2>
<p>Finally, to perform the utilitarian approach, we have from the disparity in <span class="math inline">\(D^{CF}\)</span> that: <span class="math display">\[\begin{align}
  M = 0.
\end{align}\]</span> Therefore, following Algorithm 5.5 with method = UT, we compute:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute \epsilon, l</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">mean</span>(d_star[x <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">mean</span>(d_star[x <span class="sc">==</span> <span class="dv">0</span>]) <span class="sc">-</span> <span class="dv">0</span> <span class="co"># -0 since M = 0!</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>l <span class="ot">&lt;-</span> <span class="fu">sum</span>(x <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="fu">sum</span>(x <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># compute inverse function of \Delta \mid x_0</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>f0 <span class="ot">&lt;-</span> <span class="fu">ecdf</span>(delta_hat[x <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>f0.inv <span class="ot">&lt;-</span> <span class="fu">inverse</span>(f0, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># compute \delta^{x_0}</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>delta_x0 <span class="ot">&lt;-</span> <span class="fu">f0.inv</span>(<span class="dv">1</span> <span class="sc">-</span> (<span class="fu">mean</span>(delta_hat[x <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">&gt;</span> <span class="fu">quantile</span>(delta_hat, <span class="fl">0.5</span>)) <span class="sc">+</span> </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                          epsilon <span class="sc">*</span> l <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> l)))</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># compute inverse function of \Delta \mid x_0</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="fu">ecdf</span>(delta_hat[x <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>f1.inv <span class="ot">&lt;-</span> <span class="fu">inverse</span>(f1, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># get the budget</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">mean</span>(d_star)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># compute \delta^{x_1}</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>delta_x1 <span class="ot">&lt;-</span>  <span class="fu">f1.inv</span>(<span class="dv">1</span> <span class="sc">-</span> (b <span class="sc">/</span> <span class="fu">mean</span>(x <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> l <span class="sc">*</span> <span class="fu">mean</span>(delta_hat[x <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">&gt;=</span> delta_x0)))</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>d_ut <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(d))</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>d_ut[x <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> delta_hat[x <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">&gt;</span> delta_x0</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>d_ut[x <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> delta_hat[x <span class="sc">==</span> <span class="dv">1</span>] <span class="sc">&gt;</span> delta_x1</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co"># compute the allocated proportions</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="fu">tapply</span>(d_ut, x, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        0         1 
0.4996091 0.5004095 </code></pre>
</div>
</div>
<p>In particular, we have showed that <span class="math display">\[\begin{align}
  P(d^{UT} \mid x_1) - P(d^{UT} \mid x_0) \approx 0\%.
\end{align}\]</span> The true population value also equals <span class="math inline">\(0\%\)</span>.</p>
<p>In general, the policies <span class="math inline">\(D^{CF}\)</span> and <span class="math inline">\(D^{UT}\)</span> may pick different individuals for treatment. The conditions under which the policies <span class="math inline">\(D^{CF}\)</span> and <span class="math inline">\(D^{UT}\)</span> are the same are discussed in Appendix D of the paper. In the above example, these conditions are satisfied, and <span class="math inline">\(D^{CF}\)</span>, <span class="math inline">\(D^{UT}\)</span> select the same group of individuals.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-plecko2022causal" class="csl-entry" role="listitem">
Plecko, Drago, and Elias Bareinboim. 2022. <span>“Causal Fairness Analysis.”</span> <em>arXiv Preprint arXiv:2207.11385</em>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>